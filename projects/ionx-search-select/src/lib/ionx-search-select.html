<!-- Trigger -->
<ion-button
  (click)="open()"
  [disabled]="disabled()"
  [aria-haspopup]="'dialog'"
  [aria-expanded]="opened() ? 'true' : 'false'"
  [attr.aria-controls]="opened() ? listId : null"
>
  <span>{{ triggerLabel() }}</span>
  @if (multiple() && selectionCount() > 0) {
  <ion-badge class="ml-2">{{ selectionCount() }}</ion-badge>
  }
</ion-button>

<!-- Modal -->
<ion-modal
  [isOpen]="opened()"
  (didDismiss)="onDidDismiss()"
  (didPresent)="onDidPresent()"
  [attr.aria-labelledby]="titleId"
>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title [id]="titleId">{{ placeholder() }}</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" (click)="close()" [attr.aria-label]="t.closeAriaLabel">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content (keydown)="onKeydown($event)">
      <ion-searchbar
        [value]="query()"
        (ionInput)="onQuery($any($event).detail?.value ?? '')"
        [placeholder]="t.search"
        [attr.aria-label]="t.searchAriaLabel"
        [debounce]="0"
        #searchEl
      >
      </ion-searchbar>

      @if (filtered().length === 0) {
      <div class="ion-padding ion-text-center text-weak">{{ t.noResults }}</div>
      }

      <ion-list
        role="listbox"
        [attr.aria-multiselectable]="multiple() ? 'true' : null"
        [attr.aria-activedescendant]="activeDescId()"
        [id]="listId"
        #listEl
      >
        @for (opt of filtered(); track trackBy()(opt)) {
        <ion-item
          button
          role="option"
          [id]="optionId(opt)"
          [class.active]="isActive(opt)"
          [attr.aria-selected]="isSelected(opt) ? 'true' : 'false'"
          [disabled]="opt.disabled"
          (click)="pick(opt)"
        >
          <ion-label>{{ displayWith()(opt) }}</ion-label>
          @if (isSelected(opt)) { <ion-note slot="end">{{ t.selected }}</ion-note> }
        </ion-item>
        }
      </ion-list>
    </ion-content>

    @if (multiple() || (!multiple() && clearable() && hasSelection())) {
    <ion-footer>
      <ion-toolbar>
        @if(multiple()) {
        <ion-buttons slot="start">
          <ion-button fill="clear" (click)="close()">{{ t.done }}</ion-button>
        </ion-buttons>
        } @if (clearable() && hasSelection()) {
        <ion-buttons slot="end">
          <ion-button fill="clear" (click)="clear()">{{ t.clear }}</ion-button>
        </ion-buttons>
        }
      </ion-toolbar>
    </ion-footer>
    }
  </ng-template>
</ion-modal>
